<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="offlineStuffMixinForNutrientsOfInterest.html">
<link rel="import" href="redux-store.html">


<dom-module id="nc-offline-capabilities">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }
        </style>

        <div class="card">
            <h1>Offline Capability Statuses</h1>
            <ul>
                <li>This app's pages [[_isCurrentPageControlledBySWYet()]] be available off line</li>
                <li>The nutrients we care about [[areNutrientsWeCareAboutAvailableOfflineString]] available during offline use
                    of this app.</li>
                <li>The complete nutrients list [[isCompleteNutrientListAvailableOfflineString]] available offline.</li>
                <li>TODO food searches offline yet?</li>
                <li>TODO individual foods saved for offline yet?</li>
            </ul>
        </div>
    </template>

    <script>
        class NcOfflineCapabilities extends
            OfflineStuffMixinForNutientsOfInterest(
                ReduxMixin(
                    Polymer.Element
                )
            ) {

            static get is() { return 'nc-offline-capabilities'; }

            static get properties() {
                return {
                    areNutrientsWeCareAboutAvailableOfflineString: {
                        type: String,
                        value: "ARE NOT"
                    },
                    isCompleteNutrientListAvailableOfflineString: {
                        type: String,
                        value: "IS NOT"
                    }
                }
            }

            _isCurrentPageControlledBySWYet() {
                return navigator.serviceWorker.controller ? 'WILL' : 'WILL NOT YET';
            }

            ready() {
                super.ready();
                var thiswebcomponent = this;
                this._getNutrientsOfInterestFromIndexedDbIfAvailable()
                    .then((list) => {
                        thiswebcomponent.areNutrientsWeCareAboutAvailableOfflineString = (list && list.length > 0) ? "ARE" : "ARE NOT";
                    })
                    .catch((errorText) => {
                        console.warn("_getNutrientsOfInterestFromIndexedDbIfAvailable rejected with ", errorText);
                        thiswebcomponent.areNutrientsWeCareAboutAvailableOfflineString = "ARE NOT";
                    });
                    this._listVariousKindsOfCachedResponses();
            }

            _listVariousKindsOfCachedResponses() {
                const thisWebComponent = this;
                caches.keys()
                    .then((cacheNames) => {
                        return caches.open(cacheNames.find((cacheName) => { return cacheName.startsWith("$$$toolbox-cache$$$");}));
                    })
                    .then((cache) => {
                        return cache.keys();
                    })
                    .then((cacheNames) => {
                        // TODO continue to dig in the cache and summarize what 
                        // has been cached so far.
                        console.log("cacheNames", cacheNames);
                        if (!cacheNames || !cacheNames.find((cacheName) => { return cacheName.startsWith("ndb/list");})) {
                            thisWebComponent.isCompleteNutrientListAvailableOfflineString = 'IS NOT';                            
                        }
                        else {
                            thisWebComponent.isCompleteNutrientListAvailableOfflineString = 'IS';
                        }
                    });
            }
        }

        window.customElements.define(NcOfflineCapabilities.is, NcOfflineCapabilities);
    </script>
</dom-module>